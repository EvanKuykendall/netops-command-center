<!DOCTYPE html>
<html>
<head>
    <title>MSP Command Center v5</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* --- BASE THEME --- */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #111; color: #eee; overflow: hidden; }
        #container { display: flex; height: 100vh; width: 100vw; }
        
        /* --- SIDEBAR (500px) --- */
        #left-sidebar { 
            width: 500px; min-width: 500px; 
            background: #1a1a1a; 
            border-right: 1px solid #333; 
            display: flex; flex-direction: column; 
            z-index: 500;
        }
        #left-header { padding: 20px; background: #000; border-bottom: 1px solid #333; }
        h2 { margin: 0; font-size: 18px; color: #4db8ff; text-transform: uppercase; letter-spacing: 1px; }
        #client-list { flex-grow: 1; overflow-y: auto; padding: 15px; }
        #search-box { width: 100%; padding: 10px; margin-top: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }
        #toggle-add-btn { padding: 20px; background: #0078d7; border: none; color: white; font-weight: bold; cursor: pointer; border-top: 1px solid #444; font-size: 14px;}

        /* --- CLIENT ITEMS --- */
        .client-item { 
            padding: 15px; margin-bottom: 10px; border-radius: 4px; 
            cursor: pointer; position: relative; 
            background: #252525; 
            border-left: 5px solid #444; 
            transition: background 0.2s;
        }
        .client-item:hover { background: #333; border-left-color: #4db8ff; }
        
        .client-name { font-weight: bold; font-size: 15px; display: block; margin-right: 50px; }
        .client-proto { font-size: 11px; color: #888; text-transform: uppercase; margin-top: 5px; display: block;}

        .item-actions { position: absolute; right: 10px; top: 12px; }
        .btn-mini { background: none; border: none; font-size: 11px; cursor: pointer; font-weight: bold; padding: 4px 8px; color: #666; }
        .btn-mini:hover { color: white; }

        /* --- MAP AREA --- */
        #map-wrapper { flex-grow: 1; position: relative; }
        #map { height: 100%; width: 100%; }

        /* --- RIGHT SIDEBAR FORM --- */
        #right-sidebar {
            width: 300px; background: rgba(0, 0, 0, 0.95); color: white;
            position: absolute; right: 20px; top: 20px; bottom: 20px; padding: 25px;
            border-radius: 8px; display: none; z-index: 2000; box-shadow: -10px 0 30px rgba(0,0,0,0.8);
            border: 1px solid #555;
        }
        label { display: block; margin-top: 15px; font-size: 12px; color: #aaa; text-transform: uppercase; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; background: #222; border: 1px solid #555; color: white; border-radius: 4px; box-sizing: border-box; }
        .action-btn { width: 100%; padding: 12px; margin-top: 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-save { background-color: #28a745; color: white; }
        .btn-cancel { background-color: #444; color: white; margin-top: 10px; }

        /* --- POPUP STYLES --- */
        .leaflet-popup-content-wrapper { background: #222; color: #fff; border: 1px solid #444; width: 240px; }
        .leaflet-popup-tip { background: #222; }
        .connect-btn { 
            display: block; width: 100%; padding: 10px 0; margin-top: 10px; 
            text-align: center; text-decoration: none; border-radius: 4px; font-weight: bold; font-size: 14px; color: white;
        }
        
        /* NEW: Tool Buttons Grid */
        .tools-grid { display: flex; gap: 5px; margin-top: 10px; }
        .tool-btn { 
            flex: 1; background: #333; color: #ccc; text-align: center; 
            padding: 8px 0; border-radius: 4px; text-decoration: none; 
            font-size: 11px; font-weight: bold; border: 1px solid #444;
        }
        .tool-btn:hover { background: #444; color: white; border-color: #666; }

        /* Dark Mode Map Filter */
        .leaflet-layer { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
    </style>
</head>
<body>

<div id="container">
    <div id="left-sidebar">
        <div id="left-header">
            <h2>Clients</h2>
            <input type="text" id="search-box" placeholder="Search..." onkeyup="filterClients()">
        </div>
        <div id="client-list"></div>
        <button id="toggle-add-btn" onclick="toggleAddPanel()">+ ADD NEW CLIENT</button>
    </div>

    <div id="map-wrapper">
        <div id="map"></div>
        <div id="right-sidebar">
            <h2 id="form-title">Add Client</h2>
            <form id="addForm">
                <input type="hidden" id="original_name" value="">
                <label>Client Name</label>
                <input type="text" id="c_name" required>
                <label>Protocol</label>
                <select id="c_protocol">
                    <option value="wireguard">WireGuard</option>
                    <option value="openvpn">OpenVPN</option>
                </select>
                <label>Config Filename (No extension)</label>
                <input type="text" id="c_config" required>
                
                <label>LAN IP (For RDP/SSH)</label>
                <input type="text" id="c_lan_ip" placeholder="e.g. 192.168.1.10">

                <label>Address (Auto-Locate)</label>
                <input type="text" id="c_address" required>
                <button type="submit" class="action-btn btn-save" id="save-btn">FIND & SAVE</button>
                <button type="button" class="action-btn btn-cancel" onclick="toggleAddPanel()">CANCEL</button>
            </form>
        </div>
    </div>
</div>

<script>
    var map = L.map('map').setView([41.75, -124.2], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    var markers = {};
    var allClients = [];
    var activeClientName = null;

    try { activeClientName = localStorage.getItem('activeVPN'); } catch(e) {}

    function loadClients() {
        fetch('/api/clients')
            .then(res => res.json())
            .then(data => {
                allClients = data;
                renderList(data);
            });
    }

    function renderList(data) {
        var listContainer = document.getElementById('client-list');
        listContainer.innerHTML = ''; 
        for (var key in markers) { map.removeLayer(markers[key]); }
        markers = {};

        data.forEach(client => {
            var isActive = (client.name === activeClientName);
            addMarkerToMap(client, isActive);
            
            const item = document.createElement('div');
            item.className = 'client-item';
            
            var iconHTML = "";
            var nameColor = "#eee"; 

            if (isActive) {
                item.style.borderLeft = "6px solid #28a745"; 
                nameColor = "#28a745";
                iconHTML = " ‚úÖ <span style='font-size:10px; color:#28a745'>CONNECTED</span>";
            }

            item.innerHTML = `
                <div class="item-actions">
                    <button class="btn-mini" onclick="editClient(event, '${client.name}')">EDIT</button>
                    <button class="btn-mini" onclick="deleteClient(event, '${client.name}')">DEL</button>
                </div>
                <span class="client-name" style="color: ${nameColor}">
                    ${client.name} ${iconHTML}
                </span>
                <span class="client-proto">${client.protocol}</span>
            `;
            item.onclick = function() { 
                map.flyTo([client.lat, client.lng], 14);
                if (markers[client.name]) setTimeout(() => { markers[client.name].openPopup(); }, 500);
            };
            listContainer.appendChild(item);
        });
    }

    function addMarkerToMap(client, isActive) {
        var btnText = isActive ? "üõë DISCONNECT VPN" : "üöÄ CONNECT VPN";
        var btnAction = isActive ? "disconnect" : "connect";
        var btnBg = isActive ? "#dc3545" : "#0078d7"; 

        if (!isActive && client.protocol === 'openvpn') btnBg = "#e0a800"; 

        var vpnLink = `mspvpn://${client.protocol}/${btnAction}/${client.config}`;
        
        // --- NEW BUTTONS LOGIC ---
        var toolsHTML = "";
        if (client.lan_ip) {
            toolsHTML = `
            <div class="tools-grid">
                <a href="mspvpn://rdp/open/${client.lan_ip}" class="tool-btn">üíª RDP</a>
                <a href="mspvpn://ssh/open/${client.lan_ip}" class="tool-btn">üìü SSH</a>
                <a href="mspvpn://https/open/${client.lan_ip}" class="tool-btn">üåê WEB</a>
            </div>
            `;
        }

        var popup = `<b>${client.name}</b><br>
                     <span style="font-size:11px; color:#aaa">${client.address || ''}</span><br>
                     <span style="font-size:10px; color:#888">IP: ${client.lan_ip || 'N/A'}</span>
                     <a href="${vpnLink}" class="connect-btn" 
                        style="background-color: ${btnBg} !important;" 
                        onclick="toggleVPN('${client.name}', '${btnAction}')">${btnText}</a>
                     ${toolsHTML}`;

        var marker = L.marker([client.lat, client.lng]).addTo(map).bindPopup(popup);
        markers[client.name] = marker;
    }

    window.toggleVPN = function(name, action) {
        activeClientName = (action === 'connect') ? name : null;
        try { localStorage.setItem('activeVPN', activeClientName || ""); } catch(e) {}
        map.closePopup();
        setTimeout(loadClients, 100); 
    };

    function toggleAddPanel() {
        var panel = document.getElementById('right-sidebar');
        panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
        if(panel.style.display === 'block') {
            document.getElementById('addForm').reset();
            document.getElementById('save-btn').innerText = "FIND & SAVE";
        }
    }
    
    function editClient(e, name) {
        e.stopPropagation();
        var client = allClients.find(c => c.name === name);
        if(!client) return;
        document.getElementById('c_name').value = client.name;
        document.getElementById('c_protocol').value = client.protocol;
        document.getElementById('c_config').value = client.config;
        document.getElementById('c_address').value = client.address || "";
        document.getElementById('c_lan_ip').value = client.lan_ip || ""; // Populate Field
        
        document.getElementById('right-sidebar').style.display = 'block';
        document.getElementById('save-btn').innerText = "UPDATE CLIENT";
        window.deleteClient(e, name, true); 
    }

    document.getElementById('addForm').onsubmit = function(e) {
        e.preventDefault();
        var data = {
            name: document.getElementById('c_name').value,
            protocol: document.getElementById('c_protocol').value,
            config: document.getElementById('c_config').value,
            address: document.getElementById('c_address').value,
            lan_ip: document.getElementById('c_lan_ip').value // Save Field
        };
        fetch('/api/clients', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        }).then(() => {
            toggleAddPanel();
            loadClients();
        });
    };

    window.deleteClient = function(e, name, silent) {
        if(e) e.stopPropagation();
        if(silent || confirm('Delete ' + name + '?')) {
            fetch('/api/clients/' + name, { method: 'DELETE' }).then(() => { if(!silent) loadClients(); });
        }
    };
    
    function filterClients() {
        var input = document.getElementById('search-box').value.toLowerCase();
        var items = document.getElementsByClassName('client-item');
        for (var i = 0; i < items.length; i++) {
            var name = items[i].getElementsByClassName('client-name')[0].innerText.toLowerCase();
            items[i].style.display = (name.indexOf(input) > -1) ? "" : "none";
        }
    }

    loadClients();
</script>
</body>
</html>